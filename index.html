<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Epic FHIR EHR Assistant</title>
    <link rel="stylesheet" href="/src/style.css" />
    <!-- Lucide Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
</head>

<body>
    <div id="app" class="streamlined-layout">
        <!-- Main Header with Patient Info -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">
                    <i data-lucide="bot"></i>
                    EHR Assistant
                </h1>
            </div>
            
            <!-- Patient Info Section -->
            <div class="patient-header-info">
                <div id="patient-summary-header" class="patient-summary-compact">
                    <div class="patient-name">Loading Patient...</div>
                    <div class="patient-details">
                        <span class="patient-detail" id="patient-age-gender">-- / --</span>
                        <span class="patient-detail" id="patient-mrn">MRN: --</span>
                        <span class="patient-detail" id="patient-csn">CSN: --</span>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <button id="data-inspector-toggle" class="inspector-toggle" title="Show data inspector">
                    <i data-lucide="search"></i>
                </button>
                <button id="settings-toggle" class="settings-btn" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </header>

        <!-- Settings Panel (Dropdown) -->
        <div id="settings-panel" class="settings-dropdown">
            <div class="settings-content">
                <h3><i data-lucide="database"></i> Data Sources</h3>
                <p class="settings-description">Control what data the AI assistant can access</p>
                
                <div class="settings-grid">
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-patient" checked>
                        <label for="toggle-patient">
                            <i data-lucide="user"></i>
                            Patient Demographics
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-vitals" checked>
                        <label for="toggle-vitals">
                            <i data-lucide="activity"></i>
                            Vital Signs & Labs
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-meds" checked>
                        <label for="toggle-meds">
                            <i data-lucide="pill"></i>
                            Medications
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-encounters" checked>
                        <label for="toggle-encounters">
                            <i data-lucide="building-2"></i>
                            Encounters & Visits
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-conditions" checked>
                        <label for="toggle-conditions">
                            <i data-lucide="stethoscope"></i>
                            Conditions & Problems
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <input type="checkbox" id="toggle-enhanced" checked>
                        <label for="toggle-enhanced">
                            <i data-lucide="brain"></i>
                            Enhanced AI Mode
                        </label>
                        <small>Enable dynamic FHIR querying with function calling</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout Container -->
        <div class="main-layout">
            <!-- Chat Area (Main Focus) -->
            <main class="chat-main">
                <!-- Loading indicator -->
                <div id="loading" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div>Loading patient data...</div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container">
                    <!-- Chat History -->
                    <div id="chat-history" class="chat-history">
                        <div class="welcome-message">
                            <div class="welcome-header">
                                <i data-lucide="bot" size="32"></i>
                                <h3>Welcome to EHR Assistant</h3>
                            </div>
                            <p>I can help you analyze patient data, answer questions about medications, vitals, conditions, and more. Ask me anything about this patient!</p>
                            <div class="quick-start">
                                <div class="suggested-questions">
                                    <button class="suggested-question">What are the most recent vital signs?</button>
                                    <button class="suggested-question">Show me all active medications</button>
                                    <button class="suggested-question">What problems are currently active?</button>
                                    <button class="suggested-question">Summarize recent visits</button>
                                    <button class="suggested-question">Are there any concerning trends?</button>
                                    <button class="suggested-question">Show lab results from the last year</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input Area -->
                    <div class="chat-input-container">
                        <div class="input-wrapper">
                            <textarea 
                                id="chat-input" 
                                placeholder="Ask about this patient's health data..." 
                                class="chat-input"
                                rows="1"
                            ></textarea>
                            <button id="chat-submit" class="chat-submit" title="Send message">
                                <i data-lucide="search"></i>
                            </button>
                        </div>
                        
                        <div class="input-footer">
                            <div class="input-actions">
                                <button id="clear-chat" class="action-btn" title="Clear conversation">
                                    <i data-lucide="trash-2" size="16"></i>
                                    Clear
                                </button>
                                <button id="export-chat" class="action-btn" title="Export conversation">
                                    <i data-lucide="download" size="16"></i>
                                    Export
                                </button>
                            </div>
                            
                            <div class="status-info">
                                <span class="connection-status">
                                    <i data-lucide="check-circle" size="16"></i>
                                    SMART on FHIR Connected
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Data Inspector Sidebar -->
            <aside id="data-inspector" class="data-inspector" style="display: none;">
                <div class="inspector-header">
                    <h3>
                        <i data-lucide="search"></i>
                        Data Inspector
                    </h3>
                    <button id="inspector-close" class="close-btn">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                
                <div class="inspector-content">
                    <div class="inspector-description">
                        <p>This panel shows the raw FHIR data that the AI searched and used to generate responses.</p>
                    </div>
                    
                    <!-- Collapsible Recent Searches Section -->
                    <div class="collapsible-section">
                        <div class="section-header" onclick="toggleSection('recent-searches')">
                            <h4>
                                <i data-lucide="clock"></i>
                                Recent Searches
                            </h4>
                            <i data-lucide="chevron-down" class="collapse-icon"></i>
                        </div>
                        <div id="recent-searches-content" class="section-content">
                            <div id="search-history" class="search-history">
                                <div class="no-searches">No searches yet. Ask the AI a question to see FHIR queries here.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collapsible Raw Data Section -->
                    <div class="collapsible-section">
                        <div class="section-header" onclick="toggleSection('raw-data')">
                            <h4>
                                <i data-lucide="file-json"></i>
                                Raw FHIR Data
                            </h4>
                            <i data-lucide="chevron-down" class="collapse-icon"></i>
                        </div>
                        <div id="raw-data-content" class="section-content">
                            <div class="data-viewer-controls">
                                <select id="data-viewer-select">
                                    <option value="">Select a search result to view</option>
                                </select>
                                <button id="copy-raw-data" class="copy-btn" title="Copy raw data">
                                    <i data-lucide="copy" size="16"></i>
                                </button>
                            </div>
                            <div id="raw-data-viewer" class="raw-data-viewer">
                                <div class="no-data">Select a search result above to view raw FHIR data</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Hidden sections for OAuth/debugging info (keep these for functionality) -->
        <div style="display:none;">
            <div id="launch-token-data-wrapper">
                <pre id="launch-token-json"></pre>
            </div>
            <div id="auth-details-wrapper">
                <p>Access Token: <code id="access-token-display"></code></p>
                <p>Patient ID: <code id="patient-id-display"></code></p>
                <p>FHIR Server (iss): <code id="fhir-server-display"></code></p>
                <h4>Full Token Response:</h4>
                <pre id="token-response-display"></pre>
            </div>
        </div>
    </div>
    
    <script type="module" src="/src/main.js"></script>
</body>

</html>